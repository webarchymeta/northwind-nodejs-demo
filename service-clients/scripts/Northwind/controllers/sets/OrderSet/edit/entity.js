/* ------------------------------------------------------------------------------
 *
 *     This code was generated by CGW X-Script Code Generator.
 *
 *     Archymeta Information Technologies Co., Ltd.
 *
 *     Changes to this file, especially those bit flags, may cause incorrect behavior and will be lost if
 *     the code is regenerated.
 * 
 ------------------------------------------------------------------------------ */

define(['knockout', 'config', 'model'], function (ko, config, model) {

    var c = function () {

        var self = this;

        childSelectedEntity = null;
        currentDisplayEntity = null;
        currentUpdatingEntity = null;
        currentSelectedSet = null;

        var EntityTabUpdating = false;
        var currEntityTabIndex = 0;
        var OKStr = 'OK';
        var CancelStr = 'Cancel';

        var updateEntityDetails = function () {
            $("#EntityDetails .Details .SetNav").accordion({
                collapsible: true,
                heightStyle: "auto"
            });
            $("#EntityDetails .Details .SetNav .ui-accordion-content").show();
            $("#EntityDetails .Details .SetNav button").button();
            $("#EntityDetails .Details .Tabs button").button();
            $("#EntityDetails .Details .Tabs").tabs({
                heightStyle: "auto",
                active: currEntityTabIndex,
                activate: function (event, ui) {
                    if (EntityTabUpdating) return;
                    currEntityTabIndex = ui.newTab.index();
                }
            }).css({
                'min-height': '220px',
                'overflow': 'auto'
            });;
            $(".resizeblock").on("click", function () {
                $(this).resizable({ aspectRatio: true });
            });
        }

        self.MaterializeCustomerRef = function (data, event) {
            data.MaterializeCustomerRef().done(function () {
                if (set !== null) {
                    for (var i = 0; i < set.CurrentPage().Items().length; i++) {
                        var e = set.CurrentPage().Items()[i];
                        if (e.CustomerID() == data.CustomerID() && e !== data) {
                            e.data.CustomerRef = data.CustomerRef();
                            e.CustomerRef(e.data.CustomerRef);
                            e.IsCustomerRefMaterialized(true);
                        }
                    }
                }
                $(event.currentTarget).qtip({
                    overwrite: true,
                    content: data.CustomerRef() ? data.CustomerRef().DistinctString : 'null',
                    position: {
                        my: 'left bottom',
                        at: 'top left',
                        target: $(event.currentTarget)
                    },
                    show: {
                        event: 'none',
                        ready: true,
                        solo: true
                    },
                    hide: 'unfocus'
                });
                $(event.currentTarget).qtip('toggle', true);
            });
            event.stopPropagation();
            return false;
        }

        self.display_CustomerRef = function (data, event) {
            $("#displayWindow").dialog('option', 'title', 'Order View');
            if (data.data.CustomerID !== null) {
                $("#displayWindow").dialog("open");
                if (!data.IsCustomerRefMaterialized()) {
                    data.MaterializeCustomerRef().done(function () {
                        $("#displayFrame")[0].src = '../Customer/LoadEntityView?CustomerID=' + data.CustomerID();
                    });
                } else {
                    $("#displayFrame")[0].src = '../Customer/LoadEntityView?CustomerID=' + data.CustomerID();
                }
            }
        }

        self.select_CustomerID = function (data, event) {
            var selBtns = {};
            selBtns[OKStr] = function () { 
                CustomerID_selected();
                $(this).dialog('close');
            }
            selBtns[CancelStr] = function () { 
                childSelectedEntity = null; 
                $(this).dialog('close');
            };
            $("#selectWindow").dialog('option', 'title', 'Customer View');    
            $("#selectWindow").dialog('option', 'buttons', selBtns);    
            $("#selectWindow").dialog("open");
            currentUpdatingEntity = data;
            if (data.data !== null) {
                if (data.CustomerID() !== null) {
                    $("#selectFrame")[0].src = '../Customer/SelectView?filter=' + encodeURIComponent('CustomerID !== ' + data.CustomerID());
                } else {
                    $("#selectFrame")[0].src = '../Customer/SelectView?filter=';
                }
            } else {
                $("#selectFrame")[0].src = '../Customer/SelectView?filter=';
            }
            event.stopPropagation();
            return false;
        }

        var CustomerID_selected = function () {
            if (currentUpdatingEntity !== null && childSelectedEntity !== null) {
                currentUpdatingEntity.CustomerID(childSelectedEntity.CustomerID());
            }
        }

        self.MaterializeShipperRef = function (data, event) {
            data.MaterializeShipperRef().done(function () {
                if (set !== null) {
                    for (var i = 0; i < set.CurrentPage().Items().length; i++) {
                        var e = set.CurrentPage().Items()[i];
                        if (e.ShipVia() == data.ShipVia() && e !== data) {
                            e.data.ShipperRef = data.ShipperRef();
                            e.ShipperRef(e.data.ShipperRef);
                            e.IsShipperRefMaterialized(true);
                        }
                    }
                }
                $(event.currentTarget).qtip({
                    overwrite: true,
                    content: data.ShipperRef() ? data.ShipperRef().DistinctString : 'null',
                    position: {
                        my: 'left bottom',
                        at: 'top left',
                        target: $(event.currentTarget)
                    },
                    show: {
                        event: 'none',
                        ready: true,
                        solo: true
                    },
                    hide: 'unfocus'
                });
                $(event.currentTarget).qtip('toggle', true);
            });
            event.stopPropagation();
            return false;
        }

        self.display_ShipperRef = function (data, event) {
            $("#displayWindow").dialog('option', 'title', 'Order View');
            if (data.data.ShipVia !== null) {
                $("#displayWindow").dialog("open");
                if (!data.IsShipperRefMaterialized()) {
                    data.MaterializeShipperRef().done(function () {
                        $("#displayFrame")[0].src = '../Shipper/LoadEntityView?ShipperID=' + data.ShipVia();
                    });
                } else {
                    $("#displayFrame")[0].src = '../Shipper/LoadEntityView?ShipperID=' + data.ShipVia();
                }
            }
        }

        self.select_ShipVia = function (data, event) {
            var selBtns = {};
            selBtns[OKStr] = function () { 
                ShipVia_selected();
                $(this).dialog('close');
            }
            selBtns[CancelStr] = function () { 
                childSelectedEntity = null; 
                $(this).dialog('close');
            };
            $("#selectWindow").dialog('option', 'title', 'Shipper View');    
            $("#selectWindow").dialog('option', 'buttons', selBtns);    
            $("#selectWindow").dialog("open");
            currentUpdatingEntity = data;
            if (data.data !== null) {
                if (data.ShipVia() !== null) {
                    $("#selectFrame")[0].src = '../Shipper/SelectView?filter=' + encodeURIComponent('ShipperID !== ' + data.ShipVia());
                } else {
                    $("#selectFrame")[0].src = '../Shipper/SelectView?filter=';
                }
            } else {
                $("#selectFrame")[0].src = '../Shipper/SelectView?filter=';
            }
            event.stopPropagation();
            return false;
        }

        var ShipVia_selected = function () {
            if (currentUpdatingEntity !== null && childSelectedEntity !== null) {
                currentUpdatingEntity.ShipVia(childSelectedEntity.ShipperID());
            }
        }

        self.MaterializeEmployeeRef = function (data, event) {
            data.MaterializeEmployeeRef().done(function () {
                if (set !== null) {
                    for (var i = 0; i < set.CurrentPage().Items().length; i++) {
                        var e = set.CurrentPage().Items()[i];
                        if (e.EmployeeID() == data.EmployeeID() && e !== data) {
                            e.data.EmployeeRef = data.EmployeeRef();
                            e.EmployeeRef(e.data.EmployeeRef);
                            e.IsEmployeeRefMaterialized(true);
                        }
                    }
                }
                $(event.currentTarget).qtip({
                    overwrite: true,
                    content: data.EmployeeRef() ? data.EmployeeRef().DistinctString : 'null',
                    position: {
                        my: 'left bottom',
                        at: 'top left',
                        target: $(event.currentTarget)
                    },
                    show: {
                        event: 'none',
                        ready: true,
                        solo: true
                    },
                    hide: 'unfocus'
                });
                $(event.currentTarget).qtip('toggle', true);
            });
            event.stopPropagation();
            return false;
        }

        self.display_EmployeeRef = function (data, event) {
            $("#displayWindow").dialog('option', 'title', 'Order View');
            if (data.data.EmployeeID !== null) {
                $("#displayWindow").dialog("open");
                if (!data.IsEmployeeRefMaterialized()) {
                    data.MaterializeEmployeeRef().done(function () {
                        $("#displayFrame")[0].src = '../Employee/LoadEntityView?EmployeeID=' + data.EmployeeID();
                    });
                } else {
                    $("#displayFrame")[0].src = '../Employee/LoadEntityView?EmployeeID=' + data.EmployeeID();
                }
            }
        }

        self.select_EmployeeID = function (data, event) {
            var selBtns = {};
            selBtns[OKStr] = function () { 
                EmployeeID_selected();
                $(this).dialog('close');
            }
            selBtns[CancelStr] = function () { 
                childSelectedEntity = null; 
                $(this).dialog('close');
            };
            $("#selectWindow").dialog('option', 'title', 'Employee View');    
            $("#selectWindow").dialog('option', 'buttons', selBtns);    
            $("#selectWindow").dialog("open");
            currentUpdatingEntity = data;
            if (data.data !== null) {
                if (data.EmployeeID() !== null) {
                    $("#selectFrame")[0].src = '../Employee/SelectView?filter=' + encodeURIComponent('EmployeeID !== ' + data.EmployeeID());
                } else {
                    $("#selectFrame")[0].src = '../Employee/SelectView?filter=';
                }
            } else {
                $("#selectFrame")[0].src = '../Employee/SelectView?filter=';
            }
            event.stopPropagation();
            return false;
        }

        var EmployeeID_selected = function () {
            if (currentUpdatingEntity !== null && childSelectedEntity !== null) {
                currentUpdatingEntity.EmployeeID(childSelectedEntity.EmployeeID());
            }
        }

        self.display_Order_Details = function (data, event) {
            if (!data.IsOrder_DetailsMaterialized()) {
                data.MaterializeOrder_Details().done(function () {
                    display_subset('Order_Detail', data.Order_Details());
                });
            } else {
                display_subset('Order_Detail', data.Order_Details());
            }
        }

        self.display_subset = function (setname, subset) {
            var url = dbBaseUrl + setname + '/MainFilteredView?filter=' + encodeURIComponent(subset.SetFilter);
            $("#displayWindow").dialog('option', 'title', setname + ' (' + subset.SetFilter + ')');
            $("#displayWindow").dialog("open");
            $("#displayFrame")[0].src = url;
        }

    }
    return c;
})